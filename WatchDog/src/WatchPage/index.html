<!DOCTYPE html>
<html lang="en">
<head>
    <title>WATCHDOG</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--===============================================================================================-->
    <!--<link rel="icon" type="image/png" href="WTCHDGstatics/images/icons/favicon.ico" />-->
    <!--===============================================================================================-->
    <!--<link rel="stylesheet" type="text/css" href="WTCHDGstatics/vendor/bootstrap/css/bootstrap.min.css">-->
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="WTCHDGstatics/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="WTCHDGstatics/css/util.css">
    <link rel="stylesheet" type="text/css" href="WTCHDGstatics/css/main.css">
    <!--===============================================================================================-->
</head>
<body>
    <h2 class="ml-5 mt-5 lead">WatchDog</h2>
    <section class="ftco-section">
        <div class="container">
            <div class="mb-5 row">
                <input type="text" class="form-control col-md-3 m-1" id="SearchString" />
                <button onclick="" class="btn-sm btn btn-dark m-1">Search</button>
                <hr />
                <a onclick="" class="m-1">Back to Full List</a>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="table">
                        <table class="table table-hover table-responsive-lg table-lg">
                            <thead>
                                <tr>
                                    <th scope="col">Method</th>
                                    <th scope="col">Path</th>
                                    <th scope="col">Status Code</th>
                                    <th scope="col">Time Spent</th>

                                    <!--<th>&nbsp;</th>-->
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="">
                <button class="text-left mr-5 btn-sm btn btn-dark float-left">Previous</button>
                <button class="text-right ml-5 btn-sm btn btn-dark float-right">Next</button>
            </div>
        </div>
    </section>

    <!-- Modal -->
    <div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body p-5">
                    <h3 class="lead fa-underline">WatchLog</h3>
                    <div class="row">
                        <div class="col-md-12 m">
                            <p><b>Host: </b> <span id="host"></span></p>
                            <p style="word-wrap: break-word;"><b>Path: </b> <span id="path"></span></p>
                            <p style="word-wrap: break-word;"><b>Query: </b> <span id="query"></span></p>
                            <p><b>Method: </b> <span id="method"></span></p>
                            <p><b>IP Address: </b> <span id="ip"></span></p>
                            <p><b>Status Code: </b> <span id="statusCode"></span></p>
                            <p style="word-wrap: break-word;"><b>Time Spent: </b> <span id="time"></span></p>
                        </div>
                        <div class="col-md-12 purplebg m mt-3">

                            <div>

                                <!-- Nav tabs -->
                                <ul class="nav nav-tabs" role="tablist">
                                    <li role="presentation" class="active">
                                        <a href="#home" aria-controls="home" role="tab" data-toggle="tab">Request</a>
                                    </li>
                                    <li role="presentation">
                                        <a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">Response</a>
                                    </li>
                                    <li role="presentation">
                                        <a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">Headers</a>
                                    </li>
                                    <!--<li role="presentation">
                                        <a href="#settings" aria-controls="settings" role="tab" data-toggle="tab">Settings</a>
                                    </li>-->
                                </ul>

                                <!-- Tab panes -->
                                <div class="tab-content mt-3">
                                    <div role="tabpanel" class="tab-pane active" id="home">
                                        <p class="lead">Request Body: </p>
                                        <pre id="reqBody" style="word-wrap: break-word;"></pre>
                                    </div>
                                    <div role="tabpanel" class="tab-pane" id="profile">
                                        <p class="lead">Response Body: </p>
                                        <pre id="resBody" style="word-wrap: break-word;"></pre>
                                    </div>
                                    <div role="tabpanel" class="tab-pane" id="messages">
                                        <p class="lead">Request Header: </p>
                                        <pre id="reqHd" style="word-wrap: break-word;"></pre>
                                        <p class="lead">Response Header: </p>
                                        <pre id="resHd" style="word-wrap: break-word;"></pre>
                                    </div>
                                    <div role="tabpanel" class="tab-pane" id="settings">Settings</div>
                                </div>

                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="myLoginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body p-5">
                    <h3 class="lead fa-underline">WatchDog Login</h3>
                    <div class="col-md-12 m">
                        <!--<label><b>Username</b></label>-->
                        <input class="form-control m-1" type="text" placeholder="Enter Username" name="uname" id="uname" required>
                        <br/>
                        <!--<label><b>Password</b></label>-->
                        <input class="form-control m-1" type="password" placeholder="Enter Password" name="psw" id="psw" required>

                        <button class="btn btn-sm btn-dark mt-5" style="width:100%" onclick="login()" type="submit">Login</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!--===============================================================================================-->
    <script src="WTCHDGstatics/vendor/jquery/jquery-3.2.1.min.js"></script>
    <script src="WTCHDGstatics/vendor/bootstrap/js/popper.min.js"></script>
    <script src="WTCHDGstatics/vendor/bootstrap/js/bootstrap.min.js"></script>
    <script src="WTCHDGstatics/signalr/signalr.js"></script>
    <link rel="stylesheet" type="text/css" href="WTCHDGstatics/css/bootstrap.min.css">




    <script>

        var connection = new signalR.HubConnectionBuilder().withUrl("/wtchdlogger").build();

        connection.on("getLogs", function (data) {
            if (sessionStorage.getItem("loggedIn") !== null && sessionStorage.getItem("loggedIn") === sessionStorage.getItem("newloggedIn")) {
                const tr = $("<tr data-toggle='modal' data-target='#myModal' aria-expanded='false' aria-controls='collapse' class='collapsed'>" +
                    "<td>" + data.method + "</td><td>" + data.path + "</td><td>" + data.responseStatus + "</td><td>" + data.timeSpent + "</td><td><i class='fa' aria-hidden='false'></i></td></tr>");
                tr.on('click', populateModal.bind(null, data));
                $('#tableBody').prepend(tr);
            }

        });

        connection
            .start()
            .then(function () {
                getLogs()
            }).catch(err => console.log('Error while starting connection: ' + err));

        function getLogs() {
            $.ajax({
                type: "GET",
                url: "/WTCHDwatchpage",
                context: document.body,
                success: function (data) {
                    //console.log(data);
                    if (sessionStorage.getItem("loggedIn") === null) {
                        //window.alert("Not logged in")
                        $('#myLoginModal').modal('show');
        
                    } else {
                        if (sessionStorage.getItem("loggedIn") !== sessionStorage.getItem("newloggedIn")) {
                            //window.alert("Not logged in")
                            $('#myLoginModal').modal('show');
                        } else {
                            for (var i = 0; i < data.length; i++) {
                                const tr = $("<tr data-toggle='modal' data-target='#myModal' aria-expanded='false' aria-controls='collapse" + i + "' class='collapsed'>" +
                                    "<td>" + data[i].method + "</td><td>" + data[i].path + "</td><td>" + data[i].responseStatus + "</td><td>" + data[i].timeSpent + "</td><td><i class='fa' aria-hidden='false'></i></td></tr>");
                                tr.on('click', populateModal.bind(null, data[i]));
                                $('#tableBody').append(tr);
                            }
                        }
                    }

                }
            });
        }

        function login() {
            $.ajax({
                type: "POST",
                url: "/WTCHDwatchpageauth",
                data: {
                    username: $("#uname").val(),
                    password: $("#psw").val()
                },
                context: document.body,
                success: function (data) {
                    console.log("is auth" + data);
                    if (data === true) {
                        sessionStorage.setItem("newloggedIn", generateUUID())
                        sessionStorage.setItem("loggedIn", sessionStorage.getItem("newloggedIn"))
                    } else {
                        sessionStorage.setItem("loggedIn", null)
                    }
                   
                    window.location.reload()
                }
            });
        }

        function populateModal(data) {
            $('#host').text(data.host);
            $('#path').text(data.path);
            $('#query').text(data.queryString);
            $('#method').text(data.method);
            $('#ip').text(data.ipAddress);
            $('#statusCode').text(data.responseStatus);
            $('#time').text(data.timeSpent);
            $('#reqHd').text(data.requestHeaders);
            $('#resHd').text(data.responseHeaders);
            $('#reqBody').text(data.requestBody);

            $('#resBody').text(data.responseBody);

            if (data.responseBody != null) {
                var element = document.getElementById("resBody");
                var obj = JSON.parse(element.innerText);
                element.innerHTML = JSON.stringify(obj, undefined, 2);
            }
            if (data.requestBody != null) {
                var element2 = document.getElementById("reqBody");
                var obj2 = JSON.parse(element2.innerText);
                element2.innerHTML = JSON.stringify(obj, undefined, 2);
            }
        }

        function generateUUID() { // Public Domain/MIT
            var d = new Date().getTime();//Timestamp
            var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now() * 1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16;//random number between 0 and 16
                if (d > 0) {//Use timestamp until depleted
                    r = (d + r) % 16 | 0;
                    d = Math.floor(d / 16);
                } else {//Use microseconds since page-load if supported
                    r = (d2 + r) % 16 | 0;
                    d2 = Math.floor(d2 / 16);
                }
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
    </script>
    <!--===============================================================================================-->
    <script src="WTCHDGstatics/js/main.js"></script>

</body>
</html>