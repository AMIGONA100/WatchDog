<!DOCTYPE html>
<html lang="en">
<head>
    <title>WatchDog</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="WTCHDGstatics/images/icons/favicon.ico" />

    <script src="WTCHDGstatics/js/jquery-3.2.1.min.js"></script>
    <script src="WTCHDGstatics/js/popper.min.js"></script>
    <link rel="stylesheet" type="text/css" href="WTCHDGstatics/css/bootstrap.min.css" />
    <script src="WTCHDGstatics/js/bootstrap.min.js"></script>
    <script src="WTCHDGstatics/signalr/signalr.js"></script>
    <script src="WTCHDGstatics/js/moment.min.js"></script>

    <style>
        body {
            color: #000;
            overflow-x: hidden;
            height: 100%;
            background-color: #EBEFFB;
            background-repeat: no-repeat;
            font-family: 'Avenir Next LT Pro', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
        }

        fieldset {
            display: none
        }

            fieldset.show {
                display: block
            }

        select:focus,
        input:focus {
            -moz-box-shadow: none !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
            border: 1px solid #2196F3 !important;
            outline-width: 0 !important;
            font-weight: 400
        }

        button:focus {
            -moz-box-shadow: none !important;
            -webkit-box-shadow: none !important;
            box-shadow: none !important;
            outline-width: 0
        }

        .tabs {
            margin: 2px 5px 0px 5px;
            padding-bottom: 10px;
            cursor: pointer
        }

            .tabs:hover,
            .tabs.active {
                border-bottom: 1px solid #2196F3
            }

        a:hover {
            text-decoration: none;
            color: #1565C0
        }

        .box {
            margin-bottom: 10px;
            border-radius: 5px;
            padding: 10px
        }

        .modal-backdrop {
            background-color: #000000
        }

        .line {
            background-color: #CFD8DC;
            height: 1px;
            width: 100%
        }

        @media screen and (max-width: 768px) {
            .tabs h6 {
                font-size: 12px
            }
        }

        .dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>


</head>
<body>
    <section class="ftco-section">
        <div class="container">
            <div class="mb-3 mb-3 text-left">
                <h2 class="lead mt-5">WatchDog</h2>
            </div>
            <button data-toggle="modal" data-target="#clearLogsModal" class="btn-sm btn btn-dark m-1 float-right">Clear Logs</button>
            <button onclick="logOut()" class="btn-sm btn btn-dark m-1 float-right">Log out</button>
            <div class="mb-5 row">
                <select id="myVerbDropDown" class="form-control col-md-1 m-1" aria-label="Default select HTTP Verb">
                    <option selected>ALL</option>
                    <option value="POST">POST</option>
                    <option value="GET">GET</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <select id="myStatusCodeDropDown" class="form-control col-md-1 m-1" aria-label="Default select HTTP Verb">
                    <option selected>ALL</option>
                    <option value="200">200</option>
                    <option value="301">301</option>
                    <option value="302">302</option>
                    <option value="404">404</option>
                    <option value="410">410</option>
                    <option value="500">500</option>
                    <option value="503">503</option>
                </select>
                <input type="text" name="search" class="form-control col-md-2 m-1" id="searchString" />
                <button onclick="search()" class="btn-sm btn btn-dark m-1">Search</button>
                <a href="" onclick="backToList()" class="m-1 mx-auto text-right col-md-6">Back to Full List</a>
                <hr />

            </div>
            <div class="my-auto mb-5">
                <b>Realtime Connection: <span id="dot" class="dot" style="background-color: dodgerblue"></span></b>
            </div>
            <div class="mt-3 row">
                <div class="col-md-12">
                    <div class="table">
                        <table class="table table-hover table-responsive-lg table-lg shadow p-3 mb-5 bg-light rounded">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col">Method</th>
                                    <th scope="col">Path</th>
                                    <th scope="col">Status Code</th>
                                    <th scope="col">Time Spent</th>
                                    <th scope="col">Time Stamp</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <p class="lead text-center text-muted" id="pageMap"></p>
            <div class="mb-5">
                <button id="prev" class="text-left mr-5 btn-sm btn btn-dark float-left" onclick="prevPage()">Previous</button>
                <button id="next" class="text-right ml-5 btn-sm btn btn-dark float-right" onclick="nextPage()">Next</button>
            </div>
        </div>
    </section>
    <div class="modal" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body p-5 shadow-lg">
                    <h3 class="lead fa-underline">WatchLog</h3>
                    <div class="row">
                        <div class="col-md-12 m">
                            <p><b>Host: </b> <span id="host"></span></p>
                            <p style="word-wrap: break-word;"><b>Path: </b> <span id="path"></span></p>
                            <p style="word-wrap: break-word;"><b>Query: </b> <span id="query"></span></p>
                            <p><b>Method: </b> <span id="method"></span></p>
                            <p><b>IP Address: </b> <span id="ip"></span></p>
                            <p><b>Status Code: </b> <span id="statusCode"></span></p>
                            <p style="word-wrap: break-word;"><b>Time Spent: </b> <span id="time"></span></p>
                            <p style="word-wrap: break-word;"><b>Time Stamp: </b> <span id="startTime"></span></p>
                        </div>
                        <div class="col-md-12 purplebg m mt-3">


                            <div class="row d-flex justify-content-between mx-1 mx-sm-3 mb-0 pb-0 border-0">
                                <div class="tabs active" id="tab01">
                                    <h6 class="font-weight-bold">Request</h6>
                                </div>
                                <div class="tabs" id="tab02">
                                    <h6 class="text-muted">Response</h6>
                                </div>
                                <div class="tabs" id="tab03">
                                    <h6 class="text-muted">Headers</h6>
                                </div>
                            </div>
                            <div class="line mb-3"></div>

                            <div class="modal-body p-0">
                                <fieldset id="tab011" class="show">
                                    <div class="">
                                        <p class="lead">Request Body: </p>
                                        <pre id="reqBody" class="bg-light p-2" style="word-wrap: break-word;"></pre>
                                    </div>
                                </fieldset>
                                <fieldset class="" id="tab021">
                                    <div class="">
                                        <p class="lead">Response Body: </p>
                                        <pre id="resBody" class="bg-light p-2" style="word-wrap: break-word;"></pre>
                                    </div>
                                </fieldset>
                                <fieldset id="tab031">
                                    <div class="">
                                        <p class="lead">Request Header: </p>
                                        <pre id="reqHd" class="bg-light p-2" style="word-wrap: break-word;"></pre>
                                        <p class="lead mt-3">Response Header: </p>
                                        <pre id="resHd" class="bg-light p-2" style="word-wrap: break-word;"></pre>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="myLoginModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body p-5">
                    <h3 class="lead fa-underline">WatchDog Login</h3>
                    <div class="col-md-12 m">
                        <form id="myLoginForm">
                            <input class="form-control m-1" type="text" placeholder="Enter Username" name="uname" id="uname" required>
                            <br />
                            <input class="form-control m-1" type="password" placeholder="Enter Password" name="psw" id="psw" required>

                        </form>

                        <button class="btn btn-sm btn-dark mt-5" style="width:100%" onclick="login()" type="submit">Login</button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="clearLogsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body p-5 text-center">
                    <h3 class="lead fa-underline mb-3">Are you sure you want to clear all logs?</h3>
                    <div class="mx-auto text-center">
                        <a href="" data-dismiss="modal" class="mr-5">No</a>
                        <a href="" onclick="clearLogs()" class="ml-5">Yes</a>
                    </div>

                </div>
            </div>
        </div>
    </div>






    <script type="text/javascript">
        $(document).ready(function () {
            $(".tabs").click(function () {
                $(".tabs").removeClass("active");
                $(".tabs h6").removeClass("font-weight-bold");
                $(".tabs h6").addClass("text-muted");
                $(this).children("h6").removeClass("text-muted");
                $(this).children("h6").addClass("font-weight-bold");
                $(this).addClass("active");
                current_fs = $(".active");
                next_fs = $(this).attr('id');
                next_fs = "#" + next_fs + "1";
                $("fieldset").removeClass("show");
                $(next_fs).addClass("show");
                current_fs.animate({}, {
                    step: function () {
                        current_fs.css({
                            'display': 'none',
                            'position': 'relative'
                        });
                        next_fs.css({
                            'display': 'block'
                        });
                    }
                });
            });
        });

        var pageIndex = 1;
        var connection = new signalR.HubConnectionBuilder().withUrl("/wtchdlogger").build();

        connection.on("getLogs", function (data) {
            if (sessionStorage.getItem("loggedIn") !== null && sessionStorage.getItem("loggedIn") === sessionStorage.getItem("newloggedIn")) {
                const firstDigitStr = String(data.responseStatus)[0];
                var statusColor = firstDigitStr === '2' ? "text-success" : firstDigitStr === '1' || firstDigitStr === '3' ? "text-primary" : "text-danger";
                const tr = $("<tr data-toggle='modal' data-target='#myModal' aria-expanded='false' aria-controls='collapse' class='collapsed'>" +
                    "<td><b>" + data.method + "</b></td><td>" + data.path + "</td><td><b class='" + statusColor + "'> " + data.responseStatus + "</b></td><td>" + data.timeSpent + "</td><td>" + moment(data.startTime).format('LLL') + "</td></tr>");
                tr.on('click', populateModal.bind(null, data));
                $('#tableBody').prepend(tr);
            }

        });

        connection
            .start()
            .then(function () {
                getLogs();
                document.getElementById("dot").style.backgroundColor = "green";
            }).catch(err => {
                getLogs();
                document.getElementById("dot").style.backgroundColor = "red";
            });

        $("#myVerbDropDown").change(function (event) {
            $('#tableBody').empty();
            if ($("#myVerbDropDown")[0].selectedIndex === 0) {
                getLogs()
            } else {
                filterVerb($(this).val());
            }

        });

        $("#myStatusCodeDropDown").change(function (event) {
            $('#tableBody').empty();
            if ($("#myStatusCodeDropDown")[0].selectedIndex === 0) {
                getLogs()
            } else {
                filterStatusCode($(this).val());
            }

        });

        function getLogs(searchString = "", verb = "", statusCode = "") {
            $.ajax({
                type: "GET",
                url: "/WTCHDwatchpage?pageNumber=" + pageIndex + "&searchString=" + searchString + "&verbString=" + verb + "&statusCode=" + statusCode,
                context: document.body,
                success: function (data) {
                    var totalPages = data.totalPages === 0 ? 1 : data.totalPages
                    $('#pageMap').text("Page " + data.pageIndex + " of " + totalPages);
                    if (data.hasNext === false) {
                        $('#next').hide();
                    }
                    else {
                        $('#next').show();

                    }

                    if (data.hasPrevious === false) {
                        $('#prev').hide();
                    }
                    else {
                        $('#prev').show();
                    }

                    if (sessionStorage.getItem("loggedIn") === null) {
                        $('#myLoginModal').modal('show');

                    } else {
                        if (sessionStorage.getItem("loggedIn") !== sessionStorage.getItem("newloggedIn")) {
                            $('#myLoginModal').modal('show');
                        } else {
                            for (var i = 0; i < data.logs.length; i++) {
                                const firstDigitStr = String(data.logs[i].responseStatus)[0];
                                var statusColor = firstDigitStr === '2' ? "text-success" : firstDigitStr === '1' || firstDigitStr === '3' ? "text-primary" : "text-danger";
                                const tr = $("<tr data-toggle='modal' data-target='#myModal' aria-expanded='false' aria-controls='collapse" + i + "' class='collapsed'>" +
                                    "<td><b>" + data.logs[i].method + "</b></td><td>" + data.logs[i].path + "</td><td><b class='" + statusColor + "'> " + data.logs[i].responseStatus + "</b ></td ><td>" + data.logs[i].timeSpent + "</td><td>" + moment(data.logs[i].startTime).format('LLL') + "</td></tr > ");
                                tr.on('click', populateModal.bind(null, data.logs[i]));
                                $('#tableBody').append(tr);
                            }
                        }
                    }

                }
            });
        }


        function clearLogs() {
            $.ajax({
                type: "POST",
                url: "/WTCHDwatchpage/ClearLogs",
                success: function (data) {
                    window.location.reload()
                }
            });
        }

        function search() {
            pageIndex = 1;
            $('#tableBody').empty();
            var ss = $('#searchString').val();
            getLogs(ss, $('#myVerbDropDown').val() == "ALL" ? "" : $('#myVerbDropDown').val(), $('#myStatusCodeDropDown').val() == "ALL" ? "" : $('#myStatusCodeDropDown').val());
        }

        function filterVerb(verbString) {
            pageIndex = 1;
            $('#tableBody').empty();
            getLogs($('#searchString').val(), verbString, $('#myStatusCodeDropDown').val() == "ALL" ? "" : $('#myStatusCodeDropDown').val());
        }

        function filterStatusCode(statusCodeString) {
            pageIndex = 1;
            $('#tableBody').empty();
            getLogs($('#searchString').val(), $('#myVerbDropDown').val() == "ALL" ? "" : $('#myVerbDropDown').val(), statusCodeString);
        }

        function nextPage() {
            ++pageIndex;
            $('#tableBody').empty();
            getLogs();
        }

        function prevPage() {
            if (pageIndex > 1)
                --pageIndex;
            $('#tableBody').empty();
            getLogs();
        }

        function backToList() {
            pageIndex = 1;
            $('#tableBody').empty();
            getLogs();
        }

        function logOut() {
            sessionStorage.clear();
            window.location.reload();
        }
        function login() {
            var form = document.querySelector('form')
            form.reportValidity()
            if (form.checkValidity()) {
                $.ajax({
                    type: "POST",
                    url: "/WTCHDwatchpage/Auth",
                    data: {
                        username: $("#uname").val(),
                        password: $("#psw").val()
                    },
                    context: document.body,
                    success: function (data) {
                        if (data === true) {
                            sessionStorage.setItem("newloggedIn", generateUUID())
                            sessionStorage.setItem("loggedIn", sessionStorage.getItem("newloggedIn"))
                        } else {
                            sessionStorage.setItem("loggedIn", null)
                        }

                        window.location.reload()
                    }
                });
            }

        }

        function populateModal(data) {
            $('#host').text(data.host);
            $('#path').text(data.path);
            $('#query').text(data.queryString);
            $('#method').text(data.method);
            $('#ip').text(data.ipAddress);
            $('#statusCode').text(data.responseStatus);
            $('#time').text(data.timeSpent);
            $('#startTime').text(moment(data.startTime).format('LLL'));

            $('#reqHd').text(data.requestHeaders);
            $('#resHd').text(data.responseHeaders);
            $('#reqBody').text(data.requestBody);

            $('#resBody').text(data.responseBody);

            if (data.responseBody != null) {
                var element = document.getElementById("resBody");
                var obj = JSON.parse(element.innerText);
                element.innerHTML = JSON.stringify(obj, undefined, 2);
            }
            if (data.requestBody != null) {
                var element2 = document.getElementById("reqBody");
                var obj2 = JSON.parse(element2.innerText);
                element2.innerHTML = JSON.stringify(obj, undefined, 2);
            }
        }

        function generateUUID() { // Public Domain/MIT
            var d = new Date().getTime();//Timestamp
            var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now() * 1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16;//random number between 0 and 16
                if (d > 0) {//Use timestamp until depleted
                    r = (d + r) % 16 | 0;
                    d = Math.floor(d / 16);
                } else {//Use microseconds since page-load if supported
                    r = (d2 + r) % 16 | 0;
                    d2 = Math.floor(d2 / 16);
                }
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
    </script>
    <script src="WTCHDGstatics/js/main.js"></script>

</body>
</html>
